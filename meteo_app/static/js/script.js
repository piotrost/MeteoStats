var jednTeryt = {
  "Dolnośląskie": [
    "bolesławiecki", "dzierżoniowski", "głogowski", "górowski", "jaworski", "Jelenia Góra",
    "jeleniogórski", "kamiennogórski", "kłodzki", "Legnica", "legnicki", "lubański",
    "lubiński", "lwówecki", "milicki", "oleśnicki", "oławski",
    "polkowicki", "strzeliński", "średzki", "świdnicki", "trzebnicki", "Wałbrzych",
    "wałbrzyski", "wołowski", "Wrocław", "wrocławski", "ząbkowicki",
    "zgorzelecki", "złotoryjski"

  ],
  "Kujawsko-Pomorskie": [
    "aleksandrowski", "brodnicki", "bydgoski", "Bydgoszcz", "chełmiński", "golubsko-dobrzyński",
    "Grudziądz", "grudziądzki", "inowrocławski", "lipnowski", "mogileński", "nakielski",
    "radziejowski", "rypiński", "sępoleński", "świecki", "Toruń", "toruński",
    "tucholski", "wąbrzeski", "Włocławek", "włocławski", "żniński"
  ],
  "Lubelskie": [
    "bialski", "Biała Podlaska", "biłgorajski", "Chełm", "chełmski", "hrubieszowski", "janowski",
    "krasnostawski", "kraśnicki", "lubartowski", "lubelski", "Lublin", "łęczyński",
    "łukowski", "opolski", "parczewski", "puławski", "radzyński",
    "rycki", "świdnicki", "tomaszowski", "włodawski", "zamojski", "Zamość"
  ],
  "Lubuskie": [
    "gorzowski", "Gorzów Wielkopolski", "krośnieński", "międzyrzecki", "nowosolski", "słubicki",
    "strzelecko-drezdenecki", "sulęciński", "świebodziński", "wschowski",
    "Zielona Góra", "zielonogórski", "żagański", "żarski"
  ],
  "Łódzkie": [
    "bełchatowski", "brzeziński", "kutnowski", "łaski", "łęczycki",
    "łowicki", "łódzki wschodni", "Łódź", "opoczyński", "pabianicki", "pajęczański",
    "piotrkowski", "Piotrków Trybunalski", "poddębicki", "radomszczański", "rawski",
    "sieradzki",  "Skierniewice", "skierniewicki", "tomaszowski", "wieluński",
    "wieruszowski", "zduńskowolski", "zgierski"
  ],
  "Małopolskie": [
    "bocheński", "brzeski", "chrzanowski", "dąbrowski", "gorlicki", "krakowski", "Kraków",
    "limanowski", "miechowski", "myślenicki", "nowosądecki", "nowotarski", "Nowy Sącz",
    "olkuski", "oświęcimski", "proszowicki", "suski", "tarnowski", "Tarnów", "tatrzański",
    "wadowicki", "wielicki"
  ],
  "Mazowieckie": [
    "białobrzeski", "ciechanowski", "garwoliński", "gostyniński", "grodziski",
    "grójecki", "kozienicki", "legionowski", "lipski", "łosicki", "makowski", "miński",
    "mławski", "nowodworski", "ostrołęcki", "Ostrołęka", "ostrowski", "otwocki",
    "piaseczyński", "Płock", "płocki", "płoński", "pruszkowski", "przasnyski",
    "przysuski", "pułtuski", "Radom", "radomski", "Siedlce", "siedlecki", "sierpecki", "sochaczewski",
    "sokołowski", "szydłowiecki", "Warszawa", "warszawski zachodni", "węgrowski",
    "wołomiński", "wyszkowski", "zwoleński", "żuromiński", "żyrardowski"
  ],
  "Opolskie": [
    "brzeski", "głubczycki", "kędzierzyńsko-kozielski", "kluczborski",
    "krapkowicki", "namysłowski", "nyski", "oleski", "Opole", "opolski", "prudnicki",
    "strzelecki"
  ],
  "Podkarpackie": [
    "bieszczadzki", "brzozowski", "dębicki", "jarosławski", "jasielski",
    "kolbuszowski", "Krosno", "krośnieński", "leski", "leżajski", "lubaczowski", "łańcucki",
    "mielecki", "niżanski", "przemyski", "Przemyśl", "przeworski", "ropczycko-sędziszowski",
    "rzeszowski", "Rzeszów", "sanocki", "stalowowolski", "strzyżowski", "Tarnobrzeg", "tarnobrzeski"
  ],
  "Podlaskie": [
    "augustowski", "białostocki", "Białystok", "bielski", "grajewski", "hajnowski",
    "kolneński", "Łomża", "łomżyński", "moniecki", "sejneński", "siemiatycki",
    "sokólski", "suwalski", "Suwałki", "wysokomazowiecki", "zambrowski"
  ],
  "Pomorskie": [
    "bytowski", "chojnicki", "człuchowski", "Gdańsk", "gdański", "Gdynia", "kartuski",
    "kościerski", "kwidzyński", "lęborski", "malborski", "nowodworski",
    "pucki", "Słupsk", "słupski", "Sopot", "starogardzki", "sztumski", "tczewski", "wejherowski"
  ],
  "Śląskie": [
    "będziński", "bielski", "Bielsko-Biała", "bieruńsko-lędziński", "Bytom", "Chorzów",
    "cieszyński", "Częstochowa", "częstochowski", "Dąbrowa Górnicza", "Gliwice", "gliwicki",
    "Jastrzębie-Zdrój", "Jaworzno", "Katowice", "kłobucki", "lubliniecki", "mikołowski",
    "Mysłowice", "myszkowski", "Piekary Śląskie", "pszczyński", "raciborski", "Ruda Śląska", "rybnicki",
    "Rybnik", "Siemianowice Śląskie", "Sosnowiec", "Świętochłowice", "tarnogórski",
    "Tychy", "wodzisławski", "Zabrze", "zawierciański", "Żory", "żywiecki"
  ],
  "Świętokrzyskie": [
    "buski", "jędrzejowski", "kazimierski", "Kielce", "kielecki", "konecki",
    "opatowski", "ostrowiecki", "pińczowski", "sandomierski",
    "skarżyski", "starachowicki", "staszowski", "włoszczowski"
  ],
  "Warmińsko-Mazurskie": [
    "bartoszycki", "braniewski", "działdowski", "Elbląg", "elbląski", "ełcki",
    "giżycki", "gołdapski", "iławski", "kętrzyński", "lidzbarski",
    "mrągowski", "nidzicki", "nowomiejski", "olecki", "Olsztyn", "olsztyński",
    "ostródzki", "piski", "szczycieński", "węgorzewski"
  ],
  "Wielkopolskie": [
    "chodzieski", "czarnkowsko-trzcianecki", "gnieźnieński", "gostyński",
    "grodziski", "jarociński", "kaliski", "Kalisz", "kępiński", "kolski",
    "Konin", "koniński", "kościański", "krotoszyński", "leszczyński",
    "Leszno", "międzychodzki", "nowotomyski", "obornicki", "ostrowski",
    "ostrzeszowski", "pilski", "pleszewski", "Poznań", "poznański", "rawicki",
    "słupecki", "szamotulski", "średzki", "śremski", "turecki", "wągrowiecki",
    "wolsztyński", "wrzesiński", "złotowski"
  ],
  "Zachodniopomorskie": [
    "białogardzki", "choszczeński", "drawski", "goleniowski", "gryficki",
    "gryfiński", "kamieński", "kołobrzeski", "Koszalin", "koszaliński", "łobeski",
    "myśliborski", "policki", "pyrzycki", "sławieński", "stargardzki", "Szczecin",
    "szczecinecki", "świdwiński", "Świnoujście", "wałecki"
  ]
};var map, markersLayer;

// ********************************************
var czynnik_list = ["Temperatura powietrza (oficjalna)",
                    "Temperatura gruntu (czujnik)",
                    "Kierunek wiatru (czujnik)",
                    "Średnia prędkość wiatru czujnik 10 minut",
                    "Prędkość maksymalna (czujnik)",
                    "Suma opadu 10 minutowego",
                    "Suma opadu dobowego",
                    "Suma opadu godzinowego",
                    "Wilgotność względna powietrza (czujnik)",
                    "Największy poryw w okresie 10min ze stacji Synoptycznej",
                    "Zapas wody w śniegu (obserwator)"];
// ********************************************

window.onload = function () {
    var wojSel = document.getElementById("woj");
    var powSel = document.getElementById("pow");
    var form = document.getElementById("dataForm");
    // ********************************************
    var czynnikSel = document.getElementById("czynnik");
    // ********************************************

    // Inicjalizacja mapy
    map = L.map('map').setView([52.0, 19.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Warstwa markerów
    markersLayer = L.layerGroup().addTo(map);

    // Wypełnianie województw
    for (var woj in jednTeryt) {
        wojSel.options[wojSel.options.length] = new Option(woj, woj);
    }

    // ********************************************
    // Wypełnianie czynników
    for (var czynnik in czynnik_list) {
        czynnikSel.options[czynnikSel.options.length] = new Option(czynnik_list[czynnik], czynnik_list[czynnik]);
    }
    // ********************************************

    // Aktualizacja listy powiatów po zmianie województwa
    wojSel.onchange = function () {
        powSel.length = 1;
        var pow = jednTeryt[this.value];
        if (pow) {
            pow.forEach(function (pow) {
                powSel.options[powSel.options.length] = new Option(pow, pow);
            });
        }
    };

    // Obsługa formularza
    form.onsubmit = function (event) {
        event.preventDefault();

        const startDate = document.getElementById("start_date").value;
        const endDate = document.getElementById("end_date").value;
        const woj = wojSel.value;
        const pow = powSel.value;
        // ********************************************
        const czynnik = czynnikSel.value;
        // ********************************************

        // Wywołanie funkcji plot
        // ********************************************
        fetchPlot(startDate, endDate, woj, pow, czynnik);
        // ********************************************

        // Wywołanie funkcji do aktualizacji mapy
        fetchStations(woj, pow);
    };
};

// Funkcja do pobierania wykresu
// ********************************************
function fetchPlot(startDate, endDate, woj, pow, czynnik) {
// ********************************************
    const formData = new FormData();
    formData.append("start_date", startDate);
    formData.append("end_date", endDate);
    formData.append("woj", woj);
    formData.append("pow", pow);
    // ********************************************
    formData.append("czynnik", czynnik);
    // ********************************************

    fetch("/plot", {
        method: "POST",
        body: formData,
    })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error("Błąd podczas generowania wykresu.");
            }
        })
        .then(blob => {
            const url = URL.createObjectURL(blob);
            document.querySelector("iframe[name='plot_frame']").src = url;
        })
        .catch(error => {
            console.error("Błąd w fetchPlot:", error);
        });
}

// Funkcja do pobierania danych stacji
function fetchStations(woj, pow) {
    fetch("/stations", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ woj: woj, pow: pow }),
    })
        .then(response => response.json())
        .then(data => {
            updateMap(data);
        })
        .catch(error => {
            console.error("Błąd podczas pobierania danych stacji:", error);
        });
}

// Funkcja do aktualizacji mapy
function updateMap(stations) {
    markersLayer.clearLayers();

    stations.forEach(station => {
        const coords = station.geometry.coordinates;
        const name = station.properties.name;

        if (coords && coords.length === 2) {
            L.marker([coords[1], coords[0]])
                .addTo(markersLayer)
                .bindPopup(`Stacja: ${name}`);
        }
    });

    if (stations.length > 0) {
        const firstStation = stations[0].geometry.coordinates;
        map.setView([firstStation[1], firstStation[0]], 10);
    }
}
